<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0077)https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr" class="js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <title>Finite State Machine with Annotations | Java.net</title>
  
<link rel="shortcut icon" href="https://weblogs.java.net/sites/default/files/java_adaptive_favicon_2.png" type="image/x-icon">
<meta name="description" content="Java.net is the source for Java Technology Collaboration.">
<meta name="keywords" content="java,java.net,java technology collaboration,java collaboration,javafx,glassfiish,embedded,netbeans,J2SE">
<link rel="canonical" href="http://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html">
<meta name="revisit-after" content="1 day">
  <link type="text/css" rel="stylesheet" media="all" href="./Finite State Machine with Annotations   Java.net_files/css_79e4d31d7ed8a77cf07c564bec2bea70.css">
  <style type="text/css">#container{width:100%;}.two-sidebars .content-inner{margin-left:240px; margin-right:240px;}.sidebar-first .content-inner{margin-left:240px; margin-right:0;}.sidebar-last .content-inner{margin-right:240px; margin-left:0;}#sidebar-first{width:240px;margin-left:-100%;}#sidebar-last{width:240px;margin-left:-240px;}</style>    <!--[if lte IE 6]><style type="text/css" media="all">@import "/sites/all/themes/java_adaptive/css/ie6.css";</style><![endif]-->
    <!--[if IE 7]><style type="text/css" media="all">@import "/sites/all/themes/java_adaptive/css/ie7.css";</style><![endif]-->
    <!--[if IE 8]><style type="text/css" media="all">@import "/sites/all/themes/java_adaptive/css/ie8.css";</style><![endif]-->

<style type="text/css"></style><script type="text/javascript" charset="UTF-8" src="./Finite State Machine with Annotations   Java.net_files/l.js"></script></head>
<body class="not-front not-logged-in article-type-blog two-sidebars section-blog page-node-237120 lightbox-processed jsenabled">
  <div id="container">

    <div id="skip-nav" class="element-invisible">
      <!-- To adjust the display of the skip link see the Advanced theme settings (General settings), and never use display:none! -->
      <a href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#main-content">Skip to main content</a>
    </div>

        
    
          <div id="leaderboard"><div id="block-block-31" class="block">
  <div class="block-inner">

    
    <div class="content"><a href="https://java.net/people/login?original_uri=http://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html">Login</a><a href="https://java.net/people/new">Join Now</a><a href="https://java.net/projects/help/pages/Home" class="last">Help</a></div>

    
  </div>
</div> <!-- /block -->
</div> <!-- /leaderboard -->
    
    <div id="header" class="clearfix">

              <div id="branding">

                                    <div class="logo-site-name"><strong>
                <span id="logo"><a href="https://weblogs.java.net/" rel="home"><img src="./Finite State Machine with Annotations   Java.net_files/logo.png" alt="Java.net logo" title="Home page"></a></span>                              </strong></div> <!-- /logo/site name -->
                      
                      <div id="site-slogan">The Source for Java Technology Collaboration</div> <!-- /slogan -->
          
        </div> <!-- /branding -->
      
              <div id="search-box" class="hide-label">
        <!-- default search disabled  -->
          <form action="https://weblogs.java.net/search/node" method="post" id="search-theme-form">
            <div id="search">
            <!-- Filter search by content type -->
              <input type="hidden" value="search_form" id="edit-search-form" name="form_id">
              <div style="margin-left: -10px;" class="checks">
                <span><input type="checkbox" name="type[forum]" id="edit-forums" value="forum"> <span class="label">Forums</span></span>
                <span><input type="checkbox" name="type[blog]" id="edit-blogs" value="blog"> <span class="label">Blogs</span></span>
                <span><input type="checkbox" name="projects" id="edit-projects" value="project"> <span class="label">Projects</span></span>
                <span><input type="checkbox" name="people" id="edit-people" value="people"> <span class="label">People</span></span>
              </div>
            <!-- Search text field and submit -->
              <input type="text" class="form-text" id="edit-search-theme-form-1" value="Search All" size="15" onclick="this.value = &#39;&#39;" onblur="if (!this.value) this.value = &#39;&#39;" name="keys">
              <input type="submit" value="" name="op" title="Search" class="form-submit" alt="Search">
              <!-- <input type="hidden" value="9c01fd1c146753065970db8d90cb38e1" name="form_token" /> -->
            </div>
          </form>
        </div> <!-- /search box -->
      
      
    </div> <!-- /header -->

    
          <div id="primary" class="nav">
        <div id="primary-inner">
        <h2 class="element-invisible">Main Menu</h2>
        <ul class="primary-links clearfix"><li class="menu-8209"><a href="https://weblogs.java.net/" title="Return to the java.net homepage">Home</a></li>
<li class="menu-8210"><a href="https://weblogs.java.net/projects" title="View the projects hosted on java.net">Projects</a></li>
<li class="menu-8211"><a href="https://weblogs.java.net/forums" title="Participate in the java.net forums">Forums</a></li>
<li class="menu-8240"><a href="https://java.net/people" title="View all the people involved with java.net">People</a></li>
<li class="menu-8241"><a href="https://weblogs.java.net/jugs/java-user-groups" title="Get involved in your local Java User Group (JUG)">Java User Groups</a></li>
<li class="menu-19124"><a href="https://weblogs.java.net/community/jcp" title="Get involved with the Java Community Process!">JCP</a></li>
</ul>
        </div>
      </div> <!-- /primary link menu -->
        
    
    
    
    
    <div id="columns"><div class="columns-inner clearfix">

      <div id="content-column"><div class="content-inner">

        
                  <div id="content-top"><div id="block-block-20" class="block">
  <div class="block-inner">

    
    <div class="content"><div id="blog-author-top"><table><tbody><tr><td><div id="blog-author-body"><img align="left" src="./Finite State Machine with Annotations   Java.net_files/gabriele_carcassi.jpg" border="0"></div></td><td valign="top"><h2><a href="https://weblogs.java.net/blogs/carcassi">Gabriele Carcassi</a></h2><div id="blog-nav-links"><a href="https://weblogs.java.net/blog/carcassi/archive/2007/01/domain_specific.html">Domain Specific Languages and runtime code generation</a> | <a href="https://weblogs.java.net/blogs/carcassi">Main</a> | <a href="https://weblogs.java.net/blog/carcassi/archive/2008/11/scripting_java.html">Scripting Java with Javascript: trapping Swing events</a></div></td></tr></tbody></table><div id="blog-author-feedlink2"><a href="https://weblogs.java.net/blog/22047/feed"><img src="./Finite State Machine with Annotations   Java.net_files/feed.png" border="0"></a></div></div><div style="clear:both"></div><div style="border-bottom: 4px #eee solid;">&nbsp;</div></div>

    
  </div>
</div> <!-- /block -->
</div> <!-- /content-top -->
        
        <div id="main-content">

                      <div id="main-content-header">
              <h1 id="page-title">Finite State Machine with Annotations</h1>
                          </div>
          
          
          <div id="content">
          <div class="article">

    <div id="blog-submitted">Posted by <a href="https://weblogs.java.net/blog/carcassi">carcassi</a> on February 2, 2007 at 6:16 PM PST</div> 
  
    <p>This is an exercise that I did more or less an year ago to learn how to use annotations.<br>
The idea is to use the then new Java 5.0 language features to create finite state<br>
machines with no separate configuration files. By this time, probably there are<br>
already a million implementation around, but the excercise did help me quite a bit<br>
to understand how annotations can be used. Hope you like it!</p>
<p>This is an exercise that I did more or less an year ago to learn how to use annotations.<br>
The idea is to use the then new Java 5.0 language features to create finite state<br>
machines with no separate configuration files. By this time, probably there are<br>
already a million implementation around, but the excercise did help me quite a bit<br>
to understand how annotations can be used. So here it goes.</p>
<p>The idea is simply to:</p>
<ul>
<li>Have one class for each state </li>
<li>Have one method for each transition </li>
<li>Have annotations for each method describing what the next state should be
	</li>
<li>Have an interface that defines the overall machine, that is the list of<br>
	all possible states, the initial state and the final state </li>
<li>Have a generic Builder that takes the interface and provides an object instance<br>
	that implements all the plumbing </li>
</ul>
<p>The first four items are what the user would write, and the annotations will<br>
provide the information to the Builder on how to implement the state changes. The<br>
Builder needs to trap all the methods calls, route them to the correct object-state,<br>
check if there is an annotation that prescribes a state change and change the object-state<br>
for the next call. We can introspect to get all the information we need about the<br>
annotation, but how do we "trap" the method calls? Since Java 1.4 there is a class<br>
called Proxy: it allows you to create a handler that it's called every time a method<br>
is called. The handler is passed the method name and the parameters, which allows<br>
us to route the call to whatever object-state and add some logic before and after.<br>
So, we have a plan, let's see how it works in practice.</p>
<h2>The On/Off switch test case</h2>
<p>We should start with a simple example, and what could possibly be simpler than<br>
an on/off switch?</p>
<p>We said we would have one class for each state, so here is the Off class:</p>
<code class="prettyprint"><span class="kwd">package</span><span class="pln"> jafsm</span><span class="pun">.</span><span class="pln">examples</span><span class="pun">.</span><span class="pln">onoff</span><span class="pun">;</span><br><br><span class="kwd">import</span><span class="pln"> jafsm</span><span class="pun">.</span><span class="typ">Transition</span><span class="pun">;</span><br><br><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Off</span><span class="pln"> </span><span class="pun">{</span><br><br><span class="pln"> </span><span class="lit">@Transition</span><span class="pun">(</span><span class="pln">newState </span><span class="pun">=</span><span class="pln"> </span><span class="typ">On</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span><br><span class="pln"> </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> turnOn</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">System</span><span class="pun">.</span><span class="kwd">out</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Lights are on!"</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><br><span class="pun">}</span><br></code>
<p>The Off class has only one method, turnOn which will change the state to On.<br>
The On class:</p>
<code class="prettyprint"><span class="kwd">package</span><span class="pln"> jafsm</span><span class="pun">.</span><span class="pln">examples</span><span class="pun">.</span><span class="pln">onoff</span><span class="pun">;</span><br><br><span class="kwd">import</span><span class="pln"> jafsm</span><span class="pun">.</span><span class="typ">Transition</span><span class="pun">;</span><br><br><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">On</span><span class="pln"> </span><span class="pun">{</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="lit">@Transition</span><span class="pun">(</span><span class="pln">newState </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Off</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> turnOff</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">System</span><span class="pun">.</span><span class="kwd">out</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Lights are off!"</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><br><span class="pun">}</span></code>
<p>has only the turnOff method which will change the state to Off. Now we need a<br>
third class, an interface is better since all the implementation is actually in<br>
the state classes, that puts the two state classes together: the Switch class.</p>
<code class="prettyprint"><span class="kwd">package</span><span class="pln"> jafsm</span><span class="pun">.</span><span class="pln">examples</span><span class="pun">.</span><span class="pln">onoff</span><span class="pun">;</span><br><br><span class="kwd">import</span><span class="pln"> jafsm</span><span class="pun">.</span><span class="typ">FiniteStateMachine</span><span class="pun">;</span><br><br><span class="lit">@FiniteStateMachine</span><span class="pun">(</span><span class="pln">states </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="typ">On</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Off</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">},</span><span class="pln"> initialState </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Off</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">)</span><br><span class="kwd">public</span><span class="pln"> </span><span class="kwd">interface</span><span class="pln"> </span><span class="typ">Switch</span><span class="pln"> </span><span class="pun">{</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">void</span><span class="pln"> turnOn</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">void</span><span class="pln"> turnOff</span><span class="pun">();</span><br><br><span class="pun">}</span></code>
<p>This says that a Switch is a finite state machine, with On and Off as the set<br>
of states and the initial state as Off. Yeah, well... it's not that difficult to<br>
figure out, right? :-)</p>
<p>Our JUnit test for the Switch would look like this:</p>
<code class="prettyprint"><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> testSwitch</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln"> </span><span class="com">// We expect to just give the Switch class to a builder</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">Switch</span><span class="pln"> fsm </span><span class="pun">=</span><span class="pln"> </span><span class="typ">FSMBuilder</span><span class="pun">.</span><span class="pln">buildFSM</span><span class="pun">(</span><span class="typ">Switch</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span><br><br><span class="pln"> </span><span class="com">// We expect to get some sort of control to </span><br><span class="pln"> </span><span class="com">// know in which state the FSM is</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">FSMControl</span><span class="pln"> fsmControl </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">FSMControl</span><span class="pun">)</span><span class="pln"> fsm</span><span class="pun">;</span><br><br><span class="pln"> </span><span class="com">// The initial state should be Off</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; assertEquals</span><span class="pun">(</span><span class="str">"Off"</span><span class="pun">,</span><span class="pln"> fsmControl</span><span class="pun">.</span><span class="pln">getCurrentState</span><span class="pun">());</span><br><br><span class="pln"> </span><span class="com">// If we turn the switch on, the state should be On</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fsm</span><span class="pun">.</span><span class="pln">turnOn</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; assertEquals</span><span class="pun">(</span><span class="str">"On"</span><span class="pun">,</span><span class="pln"> fsmControl</span><span class="pun">.</span><span class="pln">getCurrentState</span><span class="pun">());</span><br><br><span class="pln"> </span><span class="com">// If we turn it back off, the state should be Off</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fsm</span><span class="pun">.</span><span class="pln">turnOff</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; assertEquals</span><span class="pun">(</span><span class="str">"Off"</span><span class="pun">,</span><span class="pln"> fsmControl</span><span class="pun">.</span><span class="pln">getCurrentState</span><span class="pun">());</span><br><br><span class="pln"> </span><span class="com">// If we turn it off again, it should complain as the</span><br><span class="pln"> </span><span class="com">// switch is already Off. The state should remain Off</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fsm</span><span class="pun">.</span><span class="pln">turnOff</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">fail</span><span class="pun">(</span><span class="str">"Shouldn't allow to turn off twice"</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Exception</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="com">// Failed to turn off twice: good</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; assertEquals</span><span class="pun">(</span><span class="str">"Off"</span><span class="pun">,</span><span class="pln"> fsmControl</span><span class="pun">.</span><span class="pln">getCurrentState</span><span class="pun">());</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span></code>
<h2>An Annotated Finite State Machine framework</h2>
<p>So, the "only" thing to do is implement the annotations and the builder!. Let's<br>
start with the annotations first. The Transition annotation will be:</p>
<code class="prettyprint"><span class="kwd">package</span><span class="pln"> jafsm</span><span class="pun">;</span><br><br><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">annotation</span><span class="pun">.</span><span class="typ">Retention</span><span class="pun">;</span><br><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">annotation</span><span class="pun">.</span><span class="typ">RetentionPoliy</span><span class="pun">;</span><br><br><span class="lit">@Retention</span><span class="pun">(</span><span class="pln">value</span><span class="pun">=</span><span class="typ">RetentionPolicy</span><span class="pun">.</span><span class="pln">RUNTIME</span><span class="pun">)</span><br><span class="kwd">public</span><span class="pln"> </span><span class="lit">@interface</span><span class="pln"> </span><span class="typ">Transition</span><span class="pln"> </span><span class="pun">{</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> newState</span><span class="pun">();</span><br><br><span class="pun">}</span></code>
<p>This simple annotation defines a transition to a new state, independent of the<br>
arguments or return value of the method. It's retained at runtime, which means that<br>
we will be able to use introspection to find it. The other annotation we used was<br>
the FiniteStateMachine:</p>
<code class="prettyprint"><span class="kwd">package</span><span class="pln"> jafsm</span><span class="pun">;</span><br><br><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">annotation</span><span class="pun">.</span><span class="typ">Retention</span><span class="pun">;</span><br><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">lang</span><span class="pun">.</span><span class="pln">annotation</span><span class="pun">.</span><span class="typ">RetentionPolicy</span><span class="pun">;</span><br><br><span class="lit">@Retention</span><span class="pun">(</span><span class="pln">value</span><span class="pun">=</span><span class="typ">RetentionPolicy</span><span class="pun">.</span><span class="pln">RUNTIME</span><span class="pun">)</span><br><span class="kwd">public</span><span class="pln"> </span><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FiniteStateMachine</span><span class="pln"> </span><span class="pun">{</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;[]</span><span class="pln"> states</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> initialState</span><span class="pun">();</span></code><br>
<code class="prettyprint"><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="com">// TODO Object as final state flags the machine has no final state</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> finalState</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">default</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">;</span><br><br><span class="pun">}</span></code>
<p>This annotation is also retained at runtime. It defines the list of state as<br>
the set of possible states, an initialState and a possible finalState. If one doesn't<br>
specify the finalState it means the machine goes on forever. In this case, the default<br>
value (Object) is used to discriminate that case. Probably a "NoEnd" class would<br>
be more elegant. I'll pretend this is left as an exercise to cover for the fact<br>
that I was lazy.</p>
<p>So, we have our annotation, now we "only" need our builder. The first part of<br>
our builder class should be:</p>
<pre class="prettyprint"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">FSMBuilder</span><span class="pln"> </span><span class="pun">{</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">FSMBuilder</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln"> T buildFSM</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln"> classToken</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> buildFSM</span><span class="pun">(</span><span class="pln">classToken</span><span class="pun">,</span><span class="pln"> extractStateClasses</span><span class="pun">(</span><span class="pln">classToken</span><span class="pun">),</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; extractInitialState</span><span class="pun">(</span><span class="pln">classToken</span><span class="pun">),</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; extractFinalState</span><span class="pun">(</span><span class="pln">classToken</span><span class="pun">));</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">...</span></code></pre>
<p>The buildFSM is the only public method. It gets an instance of a class and returns<br>
an object of type of that class. We are using bits of generics there to avoid a<br>
type cast. We'll have three methods that will take the list of state classes, the<br>
initial and the final state and call another method. Let's first see how the states<br>
are extracted:</p>
<code class="prettyprint"><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;&gt;</span><span class="pln"> extractStateClasses</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> classToken</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">FiniteStateMachine</span><span class="pln"> fsm </span><span class="pun">=</span><span class="pln"> classToken</span><span class="pun">.</span><span class="pln">getAnnotation</span><span class="pun">(</span><span class="typ">FiniteStateMachine</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Arrays</span><span class="pun">.</span><span class="pln">asList</span><span class="pun">(</span><span class="pln">fsm</span><span class="pun">.</span><span class="pln">states</span><span class="pun">());</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> extractInitialState</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> classToken</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">FiniteStateMachine</span><span class="pln"> fsm </span><span class="pun">=</span><span class="pln"> classToken</span><span class="pun">.</span><span class="pln">getAnnotation</span><span class="pun">(</span><span class="typ">FiniteStateMachine</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> fsm</span><span class="pun">.</span><span class="pln">initialState</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> extractFinalState</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> classToken</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">FiniteStateMachine</span><span class="pln"> fsm </span><span class="pun">=</span><span class="pln"> classToken</span><span class="pun">.</span><span class="pln">getAnnotation</span><span class="pun">(</span><span class="typ">FiniteStateMachine</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> fsm</span><span class="pun">.</span><span class="pln">finalState</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><span class="pln"> </span></code>
<p>As you see, getting the values from the annotation is straight forward: you get<br>
the annotation from the classToken object, and you get the annotation properties.<br>
Now let's see what we do with those values:</p>
<pre class="prettyprint"><code><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln"> T buildFSM</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln"> fsmClassToken</span><span class="pun">,</span><span class="pln"> </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;&gt;</span><span class="pln"> stateClasses</span><span class="pun">,</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> initialStateClass</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> finalStateClass</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> buildFSM</span><span class="pun">(</span><span class="pln">fsmClassToken</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">FSMInvocationHandler</span><span class="pun">(</span><span class="pln">stateClasses</span><span class="pun">,</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; initialStateClass</span><span class="pun">,</span><span class="pln"> finalStateClass</span><span class="pun">));</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="lit">@SuppressWarnings</span><span class="pun">(</span><span class="str">"unchecked"</span><span class="pun">)</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">static</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln"> T buildFSM</span><span class="pun">(</span><span class="typ">Class</span><span class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span class="pln"> classToken</span><span class="pun">,</span><span class="pln"> </span><span class="typ">InvocationHandler</span><span class="pln"> handler</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="com">// Suppressed unchecked warning</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="com">// The proxy will be of class T as the classToken is passed as one of the</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="com">// interfaces to be implemented by the proxy.</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">T</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Proxy</span><span class="pun">.</span><span class="pln">newProxyInstance</span><span class="pun">(</span><span class="pln">classToken</span><span class="pun">.</span><span class="pln">getClassLoader</span><span class="pun">(),</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">&lt;?&gt;[]</span><span class="pln"> </span><span class="pun">{</span><span class="pln">classToken</span><span class="pun">,</span><span class="pln"> </span><span class="typ">FSMControl</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">},</span><span class="pln"> handler</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><br><span class="pun">}</span></code></pre>
<p>The first method, which is the one called by the public one, simply creates an<br>
FSMInvocationHandler and calls yet another method. The last method uses the Proxy<br>
class to create a proxy object that implements 2 interfaces, the classToken (which<br>
would be the Switch class in our testcase) and the FSMControl (which our test uses<br>
to query the machine state). The handler is actually where the magic happens: it's<br>
the object that will trap all the calls and implement the logic.</p>
<p>Notice the use of @SuppressWarnings: if it wasn't there the compiler would complain<br>
that it cannot guarantee that the output of Proxy is of type classToken. We know<br>
that is always going to be the case, as classToken is one of the interfaces that<br>
the Proxy will implement. So we pass on that guarantee to the compiler by turning<br>
off the warning. Such warning should be on the deepest possible method as you do<br>
not want to accidentally suppress other warnings.</p>
<p>As we said, the whole magic happens in the FSMInvocationHandler. So let's have<br>
a look at that.</p>
<pre class="prettyprint"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">FSMInvocationHandler</span><span class="pln"> </span><span class="kwd">implements</span><span class="pln"> </span><span class="typ">InvocationHandler</span><span class="pln"> </span><span class="pun">{</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;&gt;</span><span class="pln"> stateClasses</span><span class="pun">;</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> initialStateClass</span><span class="pun">;</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> finalStateClass</span><span class="pun">;</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Map</span><span class="pun">&lt;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;</span><span class="pln"> stateObjects </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Hashtable</span><span class="pun">&lt;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;();</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">Object</span><span class="pln"> currentState</span><span class="pun">;</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="typ">FSMInvocationHandler</span><span class="pun">(</span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;&gt;</span><span class="pln"> stateClasses</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> initialStateClass</span><span class="pun">,</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> finalStateClass</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></pre><br>
<code class="prettyprint"><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">stateClasses </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayList</span><span class="pun">&lt;</span><span class="typ">Class</span><span class="pun">&lt;?&gt;&gt;(</span><span class="pln">stateClasses</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">initialStateClass </span><span class="pun">=</span><span class="pln"> initialStateClass</span><span class="pun">;</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">finalStateClass </span><span class="pun">=</span><span class="pln"> finalStateClass</span><span class="pun">;</span><br><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; initializeStateObjects</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setInitialState</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span></code>
<p>The FSMInvocationHandler will have the list of stateClasses, the initalState<br>
and the finalState, which will be fed in by the constructor. It will also have a<br>
map stateObject that will contain one instance for each object that represent a<br>
state. It will also contain a pointer to the object that represent the current state.<br>
As part of the constructor, the stateObject map will be initialized and the initial<br>
state will be set. Here are the two method responsible:</p>
<pre class="prettyprint"><code><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> initializeStateObjects</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Cl2ass</span><span class="pun">&lt;?&gt;</span><span class="pln"> stateClass </span><span class="pun">:</span><span class="pln"> stateClasses</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stateObjects</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="pln">stateClass</span><span class="pun">,</span><span class="pln"> stateClass</span><span class="pun">.</span><span class="pln">newInstance</span><span class="pun">());</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">InstantiationException</span><span class="pln"> ex</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RuntimeException</span><span class="pun">(</span><span class="str">"State "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> stateClass</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="str">" can't be instanciated: "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> ex</span><span class="pun">.</span><span class="pln">getMessage</span><span class="pun">(),</span><span class="pln"> ex</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IllegalAccessException</span><span class="pln"> ex</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RuntimeException</span><span class="pun">(</span><span class="str">"State "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> stateClass</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="str">" has no accessible default constructor: "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> ex</span><span class="pun">.</span><span class="pln">getMessage</span><span class="pun">(),</span><span class="pln"> ex</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><span class="pln">&nbsp;&nbsp;&nbsp; </span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> setInitialState</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; currentState </span><span class="pun">=</span><span class="pln"> stateObjects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">initialStateClass</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span></code></pre>
<p>To initialize the state object we simply iterate over the state classes and create<br>
an object for each one, and to set the initial state, we simply retrieve the object<br>
for the initial state class. And now the core of the plumbing:</p>
<pre class="prettyprint"><code><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">Object</span><span class="pln"> invoke</span><span class="pun">(</span><span class="typ">Object</span><span class="pln"> proxy</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Method</span><span class="pln"> method</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">throws</span><span class="pln"> </span><span class="typ">Throwable</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="str">"getCurrentState"</span><span class="pun">.</span><span class="pln">equals</span><span class="pun">(</span><span class="pln">method</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">())</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">(</span><span class="pln">method</span><span class="pun">.</span><span class="pln">getParameterTypes</span><span class="pun">().</span><span class="pln">length </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> currentState</span><span class="pun">.</span><span class="pln">getClass</span><span class="pun">().</span><span class="pln">getSimpleName</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">Method</span><span class="pln"> stateMethod </span><span class="pun">=</span><span class="pln"> lookupCurrentStateMethod</span><span class="pun">(</span><span class="pln">method</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">Object</span><span class="pln"> methodReturn </span><span class="pun">=</span><span class="pln"> stateMethod</span><span class="pun">.</span><span class="pln">invoke</span><span class="pun">(</span><span class="pln">currentState</span><span class="pun">,</span><span class="pln"> args</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">Transition</span><span class="pln"> transition </span><span class="pun">=</span><span class="pln"> stateMethod</span><span class="pun">.</span><span class="pln">getAnnotation</span><span class="pun">(</span><span class="typ">Transition</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">transition </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="typ">Class</span><span class="pun">&lt;?&gt;</span><span class="pln"> nextStateClass </span><span class="pun">=</span><span class="pln"> transition</span><span class="pun">.</span><span class="pln">newState</span><span class="pun">();</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; currentState </span><span class="pun">=</span><span class="pln"> stateObjects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">nextStateClass</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> methodReturn</span><span class="pun">;</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><span class="pln">&nbsp;&nbsp;&nbsp; </span><br><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">Method</span><span class="pln"> lookupCurrentStateMethod</span><span class="pun">(</span><span class="typ">Method</span><span class="pln"> method</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">return</span><span class="pln"> currentState</span><span class="pun">.</span><span class="pln">getClass</span><span class="pun">().</span><span class="pln">getMethod</span><span class="pun">(</span><span class="pln">method</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">(),</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; method</span><span class="pun">.</span><span class="pln">getParameterTypes</span><span class="pun">());</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NoSuchMethodException</span><span class="pln"> ex</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RuntimeException</span><span class="pun">(</span><span class="str">"State '"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> currentState</span><span class="pun">.</span><span class="pln">getClass</span><span class="pun">().</span><span class="pln">getName</span><span class="pun">()</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">+</span><span class="pln"> </span><span class="str">"' doesn't allow '"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> method</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">"'"</span><span class="pun">);</span><br><span class="pln">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span><br><span class="pln">&nbsp;&nbsp;&nbsp; </span><span class="pun">}</span></code></pre>
<p>The invoke method is going to be called for any method called on the switch object.<br>
First thing we check is if the getCurrentState method was called, which should return<br>
the name of the current state. In all the other cases, we try to find the method<br>
in the current object state; we don't it means that state doesn't support it so<br>
we throw an exception. If the method exists, then we forward the call with the approriate<br>
arguments to the current state object. After that we check if there is an annotation<br>
with the state we should transition to, and we change the current state object if<br>
that's the case.</p>
<h2>Missing pieces and considerations</h2>
<p>As you can see, there are a lot of details missing:</p>
<ul>
<li>the finalState is not actually used </li>
<li>we should implement equals, hashcode, clone, etc.. more consistently
	</li>
<li>we should provide annotation for those transition that depends on the arguments<br>
	or return value of the method </li>
<li>the control could be extended to have bean-like event notification for state<br>
	change </li>
<li>... </li>
</ul>
<p>But it should be clear how to go about to solve them: it's just a matter of making<br>
the FSMInvocationHandler a bit smarter and possibly creating another couple of Annotations.</p>
<p>Annotations and the Proxy class combined are pretty powerful. The amount of code<br>
for this simple example framework is really not so much: it took a Sunday afternoon<br>
to write. But it does quite a lot of things already. For example, say you where<br>
modeling some GUI that needed to change the panel displayed depending on the state<br>
of a complicated process. The annotated FSM could have a getPanel, which each state<br>
reimplements by returning the appropriate panel. Or say you are implementing an<br>
old text adventure, making a state-class out of each location, with a getDescription<br>
for what can be seen and the classic east/west/north/south for navigation.</p>
<p>And the same approach can be used whenever we need a very complex object to be<br>
partitioned in several ones to make things more manageble, or we need to inject<br>
at runtime some behavior before or after the method implementation of some interface.</p>
<p>One of the things I took out of this exercise on year ago was how powerful the<br>
Java language has become with 5.0. I wasn't really sure how these new language functionalities<br>
could be used, and this helped quite a bit.</p>
    <div class="taxonomy"><span class="label" style="font-weight: bold; margin-right: 0.5em; float: left;">Related Topics &gt;&gt;</span>
        <ul class="links inline"><li class="taxonomy_term_57"><a href="https://weblogs.java.net/topic/j2se" rel="tag" title="">J2SE</a></li>
</ul>
    </div>
      <div class="node-links"><span class="label" style="font-weight: bold; margin-right: 0.5em; float: left;">Blog Links &gt;&gt;</span>
  <ul class="links inline"><li class="comment_forbidden"><span><a href="https://weblogs.java.net/user/login?destination=comment%2Freply%2F237120%23comment-form">Login</a> or <a href="https://weblogs.java.net/user/register?destination=comment%2Freply%2F237120%23comment-form">register</a> to post comments</span></li>
<li class="print_html"><a href="https://weblogs.java.net/print/237120" title="Display a printer-friendly version of this page." class="print-page" rel="nofollow">Printer-friendly version</a></li>
<li class="blog_usernames_blog"><a href="https://weblogs.java.net/blogs/carcassi" title="Read carcassi&#39;s latest blog entries.">carcassi's blog</a></li>
<li class="statistics_counter"><span>10116 reads</span></li>
</ul>
  </div>
  
</div> <!-- /article -->
          </div>

        </div> <!-- /main-content -->

          <!--  Begin SiteCatalyst code  -->
  <script type="text/javascript" defer="" async="" src="./Finite State Machine with Annotations   Java.net_files/piwik.js"></script><script language="JavaScript" src="./Finite State Machine with Annotations   Java.net_files/s_code_remote.js"></script><script type="text/javascript" src="./Finite State Machine with Annotations   Java.net_files/metrics_group1.js"></script>
  <!--  End SiteCatalyst code  -->
      </div></div> <!-- /content-column -->

              <div id="sidebar-first" class="sidebar"><div id="block-menu-menu-get-involved" class="block">
  <div class="block-inner">

          <h2>Get Involved</h2>
    
    <div class="content"><ul class="menu">
 <li class="leaf first"><a href="https://weblogs.java.net/about-javanet" title="About java.net">About Java.net</a></li>
<li class="leaf"><a href="http://java.net/projects/adoptajsr/pages/Home" title="Adopt">Adopt a JSR</a></li>
<li class="leaf"><a href="https://weblogs.java.net/create-project" title="Create a Project">Create a Project</a></li>
<li class="leaf last"><a href="https://weblogs.java.net/javanet-linking-instructions" title="Link an offiste project">Link an Offsite Project</a></li>
 </ul>
</div>

    
  </div>
</div> <!-- /block -->
<div id="block-menu-menu-get-informed" class="block">
  <div class="block-inner">

          <h2>Get Informed</h2>
    
    <div class="content"><ul class="menu">
 <li class="leaf first"><a href="https://weblogs.java.net/articles" title="">Articles</a></li>
<li class="leaf"><a href="https://weblogs.java.net/blogfront" title="">Blogs</a></li>
<li class="leaf"><a href="https://weblogs.java.net/events" title="">Events</a></li>
<li class="leaf"><a href="http://www.oracle.com/technetwork/java/javamagazine/index.html?origref=http://java.net/projects/java-magazine" title="Subscribe to Java Magazine" target="_blank">Java Magazine</a></li>
<li class="leaf last"><a href="http://education.oracle.com/pls/web_prod-plq-dad/ou_product_category.getFamilyPage?p_family_id=48&intcmp=WWOU11042412MPP012C010" title="Java Training and Certification at Oracle University" target="_blank">Oracle University</a></li>
 </ul>
</div>

    
  </div>
</div> <!-- /block -->
</div> <!-- /sidebar-first -->
      
              <div id="sidebar-last" class="sidebar"><div id="block-block-22" class="block">
  <div class="block-inner">

          <h2>Recent Entries</h2>
    
    <div class="content"><a href="https://weblogs.java.net/blog/carcassi/archive/2012/10/28/8-common-misconceptions-units-and-references-systems-software-engineers">8 common misconceptions on units and references systems (for software engineers)</a><br><br><a href="https://weblogs.java.net/blog/carcassi/archive/2012/10/19/moving-blogger">Moving to Blogger</a><br><br><a href="https://weblogs.java.net/blog/carcassi/archive/2012/09/01/wish-list-java-array-or-numeric-collections">Wish list for java array (or numeric collections)</a><br><br></div>

    
  </div>
</div> <!-- /block -->
<div id="block-block-19" class="block">
  <div class="block-inner">

          <h2>Archives</h2>
    
    <div class="content"><a href="https://weblogs.java.net/blogarchive/carcassi/201210">October 2012</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201209">September 2012</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201208">August 2012</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201202">February 2012</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201108">August 2011</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201104">April 2011</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201012">December 2010</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201009">September 2010</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201004">April 2010</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/201002">February 2010</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/200909">September 2009</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/200903">March 2009</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/200811">November 2008</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/200702">February 2007</a><br><a href="https://weblogs.java.net/blogarchive/carcassi/200701">January 2007</a><br></div>

    
  </div>
</div> <!-- /block -->
</div> <!-- /sidebar-last -->
      
    </div></div> <!-- /columns -->

          <div id="tertiary-content"><div id="block-menu-menu-footer-menu" class="block">
  <div class="block-inner">

    
    <div class="content"><ul class="menu">
 <li class="leaf first"><a href="https://weblogs.java.net/contact" title="">Feedback</a></li>
<li class="leaf"><a href="https://weblogs.java.net/javanet-faq" title="">FAQ</a></li>
<li class="leaf"><a href="https://weblogs.java.net/javanet-web-site-terms-use" title="">Terms of Use</a></li>
<li class="leaf"><a href="http://www.oracle.com/us/legal/privacy/index.html" title="" target="_blank">Privacy</a></li>
<li class="leaf last"><a href="http://www.oracle.com/us/legal/third-party-trademarks/index.html" title="" target="_blank">Trademarks</a></li>
 </ul>
</div>

    
  </div>
</div> <!-- /block -->
</div> <!-- /tertiary-content -->
    
          <div id="footer">

                  <div id="footer-region"><div id="block-block-27" class="block">
  <div class="block-inner">

    
    <div class="content"><div style="width: 59%; float: left;">
<p>Your use of this web site or any of its content or software indicates your agreement to be bound by these <a href="https://weblogs.java.net/javanet-web-site-terms-use">Terms of Participation</a>.</p>
<p>Copyright © 2014, Oracle and/or its affiliates. All rights reserved. Oracle and Java are registered trademarks of Oracle and/or its affiliates. Other names may be trademarks of their respective owners.</p>
</div>

<div style="width: 39%; float: left; text-align: right;">
<div style="float: right;"><a href="http://www.oracle.com/" target="_blank"><img src="./Finite State Machine with Annotations   Java.net_files/oracle.png"></a><a href="http://kenai.com/" target="_blank"><img src="./Finite State Machine with Annotations   Java.net_files/kenai.png"></a><a href="http://www.cognisync.com/" target="_blank"><img src="./Finite State Machine with Annotations   Java.net_files/cognisync.png"></a><br>
<div class="powered-by">Powered by Oracle, Project Kenai and Cognisync</div></div>
</div></div>

    
  </div>
</div> <!-- /block -->
</div> <!-- /footer-region -->
        
        
        
      </div> <!-- /footer -->
    

  </div> <!-- /container -->
  <script type="text/javascript" src="./Finite State Machine with Annotations   Java.net_files/js_8562075b5b292012d20abb6b65c917bc.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/", "datetweaks": { "use_dropdown": true }, "fivestar": { "titleUser": "Your rating: ", "titleAverage": "Average: ", "feedbackSavingVote": "Saving your vote...", "feedbackVoteSaved": "Your vote has been saved.", "feedbackDeletingVote": "Deleting your vote...", "feedbackVoteDeleted": "Your vote has been deleted." }, "lightbox2": { "rtl": 0, "file_path": "/(\\w\\w/)sites/default/files", "default_image": "/sites/all/modules/lightbox2/images/brokenimage.jpg", "border_size": 0, "font_color": "000", "box_color": "fff", "top_position": "", "overlay_opacity": "0.8", "overlay_color": "000", "disable_close_click": 1, "resize_sequence": 0, "resize_speed": 400, "fade_in_speed": 400, "slide_down_speed": 600, "use_alt_layout": 1, "disable_resize": 0, "disable_zoom": 0, "force_show_nav": 0, "show_caption": 1, "loop_items": 0, "node_link_text": "View Image Details", "node_link_target": 0, "image_count": "Image !current of !total", "video_count": "Video !current of !total", "page_count": "Page !current of !total", "lite_press_x_close": "press \x3ca href=\"#\" onclick=\"hideLightbox(); return FALSE;\"\x3e\x3ckbd\x3ex\x3c/kbd\x3e\x3c/a\x3e to close", "download_link_text": "", "enable_login": false, "enable_contact": false, "keys_close": "c x 27", "keys_previous": "p 37", "keys_next": "n 39", "keys_zoom": "z", "keys_play_pause": "32", "display_image_size": "original", "image_node_sizes": "()", "trigger_lightbox_classes": "", "trigger_lightbox_group_classes": "", "trigger_slideshow_classes": "", "trigger_lightframe_classes": "", "trigger_lightframe_group_classes": "", "custom_class_handler": 0, "custom_trigger_classes": "", "disable_for_gallery_lists": true, "disable_for_acidfree_gallery_lists": true, "enable_acidfree_videos": true, "slideshow_interval": 5000, "slideshow_automatic_start": true, "slideshow_automatic_exit": true, "show_play_pause": true, "pause_on_next_click": false, "pause_on_previous_click": true, "loop_slides": false, "iframe_width": 900, "iframe_height": 700, "iframe_border": 1, "enable_video": 0 }, "prettify": { "linenums": false, "match": ".content", "nocode": "no-code", "custom": [  ], "markup": { "code": true, "pre": true, "precode": true } }, "extlink": { "extTarget": "_blank", "extClass": 0, "extSubdomains": 1, "extExclude": "", "extInclude": "", "extAlert": 0, "extAlertText": "This link will take you to an external web site. We are not responsible for their content.", "mailtoClass": 0 }, "custom_search": { "form_target": "_self", "solr": 0 } });
//--><!]]>
</script>
    <!--  Begin SiteCatalyst code  -->
<script language="JavaScript">
<!--
var s_channel="other";
//--></script>
<!--  End SiteCatalyst code  -->
  <script type="text/javascript">
<!--//--><![CDATA[//><!--
var _paq = _paq || [];(function(){var u=(("https:" == document.location.protocol) ? "" : "http://piwik.cognihosting.com/");_paq.push(["setSiteId", "1"]);_paq.push(["setTrackerUrl", u+"piwik.php"]);_paq.push(["setDoNotTrack", 1]);_paq.push(["setCookieDomain", ".java.net"]);_paq.push(["trackPageView"]);_paq.push(["enableLinkTracking"]);var d=document,g=d.createElement("script"),s=d.getElementsByTagName("script")[0];g.type="text/javascript";g.defer=true;g.async=true;g.src=u+"piwik.js";s.parentNode.insertBefore(g,s);})();
//--><!]]>
</script>


<div id="lightbox2-overlay" style="display: none;"></div>      <div id="lightbox" style="display: none;" class="lightbox2-alt-layout">        <div id="outerImageContainer" style="background-color: rgb(255, 255, 255); color: rgb(0, 0, 0);"><div id="modalContainer" style="display: none; padding: 0px;"></div><div id="frameContainer" style="display: none; padding: 0px;"></div><div id="imageContainer" style="display: none; padding: 0px;"><img id="lightboxImage" alt=""></div><div id="loading"><a href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" id="loadingLink"></a></div><div id="bottomNav"><a id="bottomNavClose" title="Close" href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" style="background-color: rgb(255, 255, 255); color: rgb(0, 0, 0);"></a><a id="bottomNavZoom" href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" style="bottom: 0px; right: 0px;"></a><a id="bottomNavZoomOut" href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" style="bottom: 0px; right: 0px;"></a></div></div>        <div id="imageDataContainer" class="clearfix" style="background-color: rgb(255, 255, 255); color: rgb(0, 0, 0);">          <div id="imageData"><div id="hoverNav"><a id="prevLink" title="Previous" href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" style="padding-top: 0px;"></a><a id="nextLink" title="Next" href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" style="padding-top: 0px;"></a></div><div id="imageDetails"><span id="caption"></span><span id="numberDisplay"></span><a id="lightshowPause" title="Pause Slideshow" href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" style="display: none;"></a><a id="lightshowPlay" title="Play Slideshow" href="https://weblogs.java.net/blog/carcassi/archive/2007/02/finite_state_ma_1.html#" style="display: none;"></a></div></div>        </div>      </div></body></html>